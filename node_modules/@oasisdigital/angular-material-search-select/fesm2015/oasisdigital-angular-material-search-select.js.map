{"version":3,"file":"oasisdigital-angular-material-search-select.js","sources":["ng://@oasisdigital/angular-material-search-select/base.ts","ng://@oasisdigital/angular-material-search-select/search-select.component.ts","ng://@oasisdigital/angular-material-search-select/search-select.module.ts","ng://@oasisdigital/angular-material-search-select/oasisdigital-angular-material-search-select.ts"],"sourcesContent":["// Base class with which to create an observable auto complete. This doesn't\n// have any connection to how the result is rendered in the Dom, with what\n// component set, and so on.\n\nimport { Input, OnDestroy } from '@angular/core';\nimport { FormControl, ControlValueAccessor } from '@angular/forms';\nimport {\n  Subscription, Observable, BehaviorSubject, of,\n  EMPTY, timer, combineLatest, Subject\n} from 'rxjs';\nimport {\n  switchMap, startWith, catchError, map, filter,\n  debounce, take, refCount, withLatestFrom,\n  publishReplay, distinctUntilChanged\n} from 'rxjs/operators';\n\nimport { OptionEntry, DataSource } from './types';\n\ninterface SearchResult {\n  search: string;\n  list?: OptionEntry[];\n  errorMessage?: string;\n}\n\nexport class SearchSelectBase implements ControlValueAccessor, OnDestroy {\n  @Input() debounceTime = 75;\n  @Input() set dataSource(ds: DataSource) { this.incomingDataSources.next(ds); }\n\n  // API provided to client component (for use in its template)\n\n  searchControl = new FormControl();\n  loading: Observable<boolean>;\n  list: Observable<OptionEntry[] | undefined>;\n  empty: Observable<boolean>;\n  errorMessage: Observable<string | undefined>;\n\n  focus() {\n    // While focused, user selection will be propagated to the form.\n    this.selectedValueSub = this.selectedValue.subscribe(this.checkAndPropagate.bind(this));\n  }\n\n  blur() {\n    this.onTouched();\n    // Now that we've lost focus, stop propagating changes.\n    if (this.selectedValueSub) {\n      this.selectedValueSub.unsubscribe();\n    }\n    // However, it's possible the user has just typed some text that will be\n    // confirmed (by the application provided function) as a match,\n    // asynchronously. We can't force the system to wait for that to happen, we\n    // are losing focus right now. But we can subscribe to pick up that one last\n    // change and propagate it if/when it arrives.\n    this.selectedValue\n      .pipe(take(1))\n      .subscribe(this.checkAndPropagate.bind(this));\n    // However, this code raises an important question about valid behavior of a\n    // Angular form control. Is it acceptable for a form control to\n    // asynchronously provide a new value when it no longer has focus?\n  }\n\n  displayWith(value: OptionEntry): string {\n    return value ? value.display : '';\n  }\n\n  // ---------------------------------------------------------------------\n  // Internals\n  // tslint:disable:member-ordering\n  private incomingValues = new Subject<any>();\n  private incomingDataSources = new BehaviorSubject<DataSource>({\n    displayValue: of,\n    search: () => of([])\n  });\n\n  private incomingDataSourcesSub: Subscription;\n  private outsideValue: any;\n  private selectedValueSub: Subscription;\n  private selectedValue: Observable<any>;\n\n  constructor() {\n    const searches: Observable<OptionEntry | string | null> =\n      this.searchControl.valueChanges.pipe(\n        startWith(this.searchControl.value),\n        distinctUntilChanged(),\n        debounce(srch => {\n          // Typing into input sends strings.\n          if (typeof srch === 'string') {\n            return timer(this.debounceTime);\n          }\n          return EMPTY; // immediate - no debounce for choosing from the list\n        })\n      );\n\n    const options: Observable<SearchResult> = combineLatest(\n      searches,\n      this.incomingDataSources.pipe(filter(ds => !!ds)),\n    ).pipe(\n      switchMap(([srch, ds]) => {\n        // Initial value is sometimes null.\n        if (srch === null) {\n          srch = '';\n        }\n        // Typing into input sends strings.\n        if (typeof srch === 'string') {\n          const search: string = srch;\n          return ds.search(srch).pipe(\n            map(list => ({ search, list })),\n            catchError(errorMessage => of({ search, errorMessage })),\n            startWith({ search })\n          );\n        }\n\n        // Selecting from Material Option List sends an object, so there is\n        // no need to call function to search for it.\n        const entry = srch as OptionEntry;\n        return of<SearchResult>({\n          search: srch.display,\n          list: [{ ...entry }]\n        });\n      }),\n      publishReplay(1),\n      refCount()\n    );\n\n    function matcher(search: string, entry: OptionEntry) {\n      return entry.display === search;\n    }\n\n    this.selectedValue = options.pipe(\n      filter(result => !!result.list),\n      withLatestFrom(this.incomingDataSources),\n      map(([result, ds]) => {\n        const list = result.list || []; // appease TS\n        const matchFn = ds.match || matcher;\n        const entry = list.find(option => matchFn(result.search, option));\n        return entry && entry.value || null;\n      }),\n      distinctUntilChanged()\n    );\n\n    this.loading = options.pipe(map(o => !o.list && !o.errorMessage));\n    this.list = options.pipe(map(o => o.list));\n    this.empty = options.pipe(map(o => o.list ? o.list.length === 0 : false));\n    this.errorMessage = options.pipe(map(o => o.errorMessage));\n\n    // a value was provided by the form; request the full entry\n    this.incomingDataSourcesSub = this.incomingValues.pipe(\n      withLatestFrom(this.incomingDataSources),\n      switchMap<[any, DataSource], Observable<OptionEntry | null>>(([value, ds]) => ds.displayValue(value))\n    )\n      .subscribe(value => this.searchControl.setValue(value));\n  }\n\n  // Implement ControlValueAccessor\n\n  writeValue(obj: any): void {\n    // Angular sometimes writes a value that didn't really change.\n    if (obj !== this.outsideValue) {\n      this.outsideValue = obj;\n      this.incomingValues.next(obj);\n    }\n  }\n\n  registerOnChange(fn: any): void {\n    this.onChange = fn;\n  }\n\n  registerOnTouched(fn: any): void {\n    this.onTouched = fn;\n  }\n\n  setDisabledState(isDisabled: boolean): void {\n    if (isDisabled) {\n      this.searchControl.disable();\n    } else {\n      this.searchControl.enable();\n    }\n  }\n\n  ngOnDestroy(): void {\n    if (this.incomingDataSourcesSub) {\n      this.incomingDataSourcesSub.unsubscribe();\n    }\n  }\n\n  private onChange = (_: any) => { };\n  private onTouched = () => { };\n\n  private checkAndPropagate(value: any) {\n    // Only send a change if there really is one.\n    if (value !== this.outsideValue) {\n      this.outsideValue = value;\n      this.onChange(value);\n    }\n  }\n}\n","import { Component, Input, ViewEncapsulation, ChangeDetectionStrategy, forwardRef } from '@angular/core';\nimport { NG_VALUE_ACCESSOR } from '@angular/forms';\n\nimport { SearchSelectBase } from './base';\n\n// The CSS approach below is the documented solution:\n// https://github.com/angular/material2/issues/3810\n// https://github.com/angular/material2/pull/7176\n\n// To set the width, style the first class something like this:\n// width: 400px;\n// max-width: 400px !important;\n// ... need to figure out how to set the number programmaticlly.\n\n@Component({\n  selector: 'search-select',\n  templateUrl: './search-select.component.html',\n  styleUrls: ['./search-select.component.css'],\n  providers: [\n    {\n      provide: NG_VALUE_ACCESSOR,\n      useExisting: forwardRef(() => SearchSelectComponent),\n      multi: true\n    }\n  ],\n  encapsulation: ViewEncapsulation.None,\n  changeDetection: ChangeDetectionStrategy.OnPush\n})\nexport class SearchSelectComponent extends SearchSelectBase {\n  @Input() placeholder: string;\n  @Input() debounceTime = 100;\n  @Input() width = '';\n  @Input() emptyText = '';\n  @Input() autoActiveFirstOption = false;\n}\n","import { NgModule } from '@angular/core';\nimport { CommonModule } from '@angular/common';\nimport { ReactiveFormsModule, FormsModule } from '@angular/forms';\nimport {\n  MatAutocompleteModule,\n  MatFormFieldModule,\n  MatInputModule,\n  MatProgressSpinnerModule,\n  MatTooltipModule\n} from '@angular/material';\n\nimport { SearchSelectComponent } from './search-select.component';\n\n@NgModule({\n  imports: [\n    CommonModule,\n    MatAutocompleteModule,\n    MatFormFieldModule,\n    MatInputModule,\n    MatProgressSpinnerModule,\n    MatTooltipModule,\n    FormsModule,\n    ReactiveFormsModule\n  ],\n  declarations: [\n    SearchSelectComponent\n  ],\n  exports: [\n    SearchSelectComponent\n  ]\n})\nexport class SearchSelectModule { }\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './index';\n\nexport {SearchSelectComponent as Éµa} from './search-select.component';"],"names":["tslib_1.__decorate"],"mappings":"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"}